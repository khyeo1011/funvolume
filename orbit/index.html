<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Orbit Volume - Static Start</title>
    <style>
        body {
            background: #0b0c10;
            color: #66fcf1;
            font-family: sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
            margin: 0;
        }

        #universe {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .planet {
            width: 80px;
            height: 80px;
            background: #45a29e;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 50px #45a29e;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #0b0c10;
            pointer-events: none;
        }

        .moon {
            width: 40px;
            height: 40px;
            background: #c5c6c7;
            border-radius: 50%;
            position: absolute;
            top: 20%;
            left: 20%;
            cursor: grab;
            box-shadow: 0 0 20px #c5c6c7;
            z-index: 2;
        }

        .moon:active {
            cursor: grabbing;
            background: #fff;
        }

        #status {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 1.5rem;
            pointer-events: none;
        }

        .distorted {
            animation: shake 0.1s infinite;
            color: red;
        }

        @keyframes shake {
            0% {
                transform: translate(1px, 1px);
            }

            100% {
                transform: translate(-1px, -1px);
            }
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        #reset {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: #45a29e;
            color: #0b0c10;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 0 10px #45a29e;
        }

        #reset:hover {
            background: #66fcf1;
        }
    </style>
</head>

<body>
    <div id="status">Volume: 0%</div>
    <button id="reset">RESET</button>
    <div id="universe">
        <canvas id="orbitCanvas"></canvas>
        <div class="planet">SOURCE</div>
        <div class="moon" id="moon"></div>
    </div>

    <script>
        const moon = document.getElementById('moon');
        const status = document.getElementById('status');
        const resetBtn = document.getElementById('reset');
        const planet = document.querySelector('.planet');
        const canvas = document.getElementById('orbitCanvas');
        const ctx = canvas.getContext('2d');

        let width, height;
        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        }
        window.addEventListener('resize', resize);
        resize();

        // Initial state
        function getRandomPos() {
            const angle = Math.random() * Math.PI * 2;
            const dist = 150 + Math.random() * 250;
            return {
                x: window.innerWidth / 2 + Math.cos(angle) * dist,
                y: window.innerHeight / 2 + Math.sin(angle) * dist
            };
        }
        let pos = getRandomPos();
        let vel = { x: 0, y: 0 };

        // Physics constants
        const G = 7000;
        const MAX_DIST = 600;

        // Interaction state
        let isDragging = false;
        let hasStarted = false; // Prevents movement before first interaction
        let anchorPos = { x: 0, y: 0 };
        const trail = [];

        moon.addEventListener('mousedown', (e) => {
            isDragging = true;
            vel = { x: 0, y: 0 };
            anchorPos = { x: pos.x, y: pos.y };
            trail.length = 0;
            e.preventDefault();
        });

        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;

            pos.x = e.clientX;
            pos.y = e.clientY;

            updateVisuals();
        });

        window.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                hasStarted = true; // Activate physics
                vel.x = (anchorPos.x - pos.x) * 0.07;
                vel.y = (anchorPos.y - pos.y) * 0.07;
            }
        });

        resetBtn.addEventListener('click', () => {
            pos = getRandomPos();
            document.body.classList.remove('distorted');
            vel = { x: 0, y: 0 };
            hasStarted = false;
            trail.length = 0;
            updateVisuals();
        });

        function loop() {
            const pRect = planet.getBoundingClientRect();
            const pCenter = { x: pRect.left + pRect.width / 2, y: pRect.top + pRect.height / 2 };

            // Logic:
            // 1. If dragging: No physics, position is set by mouse (handled in mousemove).
            // 2. If NOT dragging AND started: Apply physics.
            // 3. If NOT dragging AND NOT started: Do nothing (static).
            if (!isDragging && hasStarted) {
                const dx = pCenter.x - pos.x;
                const dy = pCenter.y - pos.y;
                const dist = Math.hypot(dx, dy);

                if (dist > 1) {
                    const dClamped = Math.max(dist, 20);
                    const force = G / (dClamped * dClamped);
                    vel.x += force * (dx / dist);
                    vel.y += force * (dy / dist);
                }
                pos.x += vel.x;
                pos.y += vel.y;
            }

            trail.push({ x: pos.x, y: pos.y });
            if (trail.length > 200) trail.shift();

            drawScene(pCenter);
            updateVisuals();
            updateStatus(pCenter);
            requestAnimationFrame(loop);
        }

        function updateVisuals() {
            moon.style.left = (pos.x - 20) + 'px';
            moon.style.top = (pos.y - 20) + 'px';
        }

        function drawScene(center) {
            ctx.clearRect(0, 0, width, height);

            // Draw Rings (Volume Thresholds)
            const volumes = [25, 50, 75];
            ctx.lineWidth = 1;

            volumes.forEach(vol => {
                // Calculate radius based on volume formula: vol = (1 - (dist - 60) / (MAX_DIST - 60)) * 100
                const r = 60 + (MAX_DIST - 60) * (1 - vol / 100);
                ctx.strokeStyle = 'rgba(69, 162, 158, 0.2)';
                ctx.beginPath();
                ctx.arc(center.x, center.y, r, 0, Math.PI * 2);
                ctx.stroke();

                ctx.fillStyle = 'rgba(69, 162, 158, 0.4)';
                ctx.font = '12px sans-serif';
                ctx.fillText(vol + '%', center.x + r + 5, center.y);
            });

            // Draw Trail
            if (trail.length > 1) {
                ctx.strokeStyle = 'rgba(197, 198, 199, 0.3)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(trail[0].x, trail[0].y);
                for (let i = 1; i < trail.length; i++) ctx.lineTo(trail[i].x, trail[i].y);
                ctx.stroke();
            }

            if (isDragging) {
                ctx.beginPath();
                ctx.moveTo(anchorPos.x, anchorPos.y);
                ctx.lineTo(pos.x, pos.y);
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.setLineDash([5, 5]);
                ctx.stroke();
                ctx.setLineDash([]);
            }
        }

        function updateStatus(pCenter) {
            const dist = Math.hypot(pCenter.x - pos.x, pCenter.y - pos.y);
            let vol = 0;
            let msg = "";
            if (hasStarted) {
                if (dist < 60) {
                    vol = 100;
                    msg = "DISTORTION WARNING";
                    document.body.classList.add('distorted');
                    if (!isDragging && hasStarted) {
                        vel.x *= 0.8;
                        vel.y *= 0.8;
                    }
                } else {
                    document.body.classList.remove('distorted');
                    if (dist > MAX_DIST) {
                        vol = 0;
                        msg = "Signal Lost";
                    } else {
                        // Logic handles volume display even when static
                        vol = Math.max(0, Math.min(100, (1 - (dist - 60) / (MAX_DIST - 60)) * 100));
                        msg = "Volume: " + Math.round(vol) + "%";
                    }
                }
            }
            else{
                vol = 0;
                msg = "Pull the moon to start";
            }
            status.innerText = msg;
        }

        loop();
    </script>
</body>

</html>